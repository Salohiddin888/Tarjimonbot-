import os
from flask import Flask, request
from telegram import Bot, Update
from telegram.ext import Dispatcher, CommandHandler, MessageHandler, Filters
from googletrans import Translator

# üîê Telegram Bot Token
TOKEN = os.environ.get("TELEGRAM_TOKEN") or "8148077100:AAGu5yAI0JgB2dYvWY9idjQAYVWATjvuBq8"

# üåê URL –¥–ª—è webhook
WEBHOOK_URL = "https://tarjimonbot-baij.onrender.com/webhook"

# üì¶ Telegram Bot –∏ Dispatcher
bot = Bot(token=TOKEN)
dispatcher = Dispatcher(bot, None, workers=4)
translator = Translator()

# ‚úÖ Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
app = Flask(__name__)

# üìç –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
def start(update, context):
    update.message.reply_text("Assalomu alaykum! Matn yuboring, men tarjima qilaman.")

# üìç –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–∞
def translate_text(update, context):
    user_text = update.message.text
    translated = translator.translate(user_text, src='auto', dest='en')
    update.message.reply_text(f"Tarjima: {translated.text}")

# ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
dispatcher.add_handler(CommandHandler("start", start))
dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, translate_text))

# üü¢ –ö–æ—Ä–Ω–µ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
@app.route('/')
def home():
    return "TarjimonBot is running!"

# üì• Webhook –ø—Ä–∏—ë–º–Ω–∏–∫
@app.route('/webhook', methods=['POST'])
def webhook():
    update = Update.de_json(request.get_json(force=True), bot)
    dispatcher.process_update(update)
    return "ok"

# üîó –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
@app.route('/setwebhook', methods=['GET'])
def set_webhook():
    success = bot.set_webhook(WEBHOOK_URL)
    return f"Webhook set: {success}"

# ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ (—Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ / –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
